<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clarke's Model Virtual Lab</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .lab-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .controls-panel, .environment-panel, .chart-panel {
            background: #fff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .input-group-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group-container .control-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568;
        }

        .control-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .control-group input::-webkit-outer-spin-button,
        .control-group input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .help-text {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        .environment-canvas {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            background: #f8fafc;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #2d3748;
        }

        h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #4a5568;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .chart-panel-wrapper {
            display: none;
        }
        
        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .info-box h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        #simulate-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background-color: #667eea;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #simulate-button:hover {
            background-color: #5a6ac2;
        }

        .checkbox-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .checkbox-group label {
            font-weight: 600;
            color: #4a5568;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
        }

        @media (max-width: 1000px) {
            .lab-grid {
                grid-template-columns: 1fr;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .input-group-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Clarke's Model Virtual Lab</h1>
            <p>Interactive simulation of mobile radio channel fading characteristics</p>
        </div>

        <div class="lab-grid">
            <div class="controls-panel">
                <h2>Parameters</h2>
                
                <div class="input-group-container">
                    <div class="control-group">
                        <label for="velocity1">Vehicle 1 Velocity (m/s)</label>
                        <input type="number" id="velocity1" value="30" min="0" max="100" step="1">
                        <div class="help-text">Controls Doppler spread and fading rate.</div>
                    </div>

                    <div class="control-group">
                        <label for="velocity2">Vehicle 2 Velocity (m/s)</label>
                        <input type="number" id="velocity2" value="60" min="0" max="100" step="1">
                        <div class="help-text">Controls Doppler spread and fading rate.</div>
                    </div>
                    
                    <div class="control-group">
                        <label for="velocity3">Vehicle 3 Velocity (m/s)</label>
                        <input type="number" id="velocity3" value="90" min="0" max="100" step="1">
                        <div class="help-text">Controls Doppler spread and fading rate.</div>
                    </div>
                </div>
                <div class="input-group-container">
                    <div class="control-group">
                        <label for="frequency">Carrier Frequency (MHz)</label>
                        <input type="number" id="frequency" value="900" min="100" max="6000" step="100">
                        <div class="help-text">Affects wavelength and Doppler frequency.</div>
                    </div>

                    <div class="control-group">
                        <label for="scatterers">Number of Scatterers</label>
                        <input type="number" id="scatterers" value="20" min="6" max="50" step="2">
                        <div class="help-text">More scatterers provide a better approximation of the model.</div>
                    </div>
                </div>
                
                <button id="simulate-button">Simulate</button>

                <div class="info-box">
                    <h4>Clarke's Model</h4>
                    <p>Models multipath fading in mobile communications assuming:</p>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.6;">
                        <li>Scatterers uniformly distributed</li>
                        <li>Equal signal strength from all paths</li>
                        <li>Mobile receiver in motion</li>
                    </ul>
                </div>
            </div>

            <div class="environment-panel">
                <h2>Scattering Environment</h2>
                <canvas id="environmentCanvas" class="environment-canvas"></canvas>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-panel-wrapper" id="autocorrelationPanel">
                <div class="chart-panel">
                    <h3>Autocorrelation Function R(Ï„)</h3>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="v1-autocorr-check" checked> Vehicle 1</label>
                        <label><input type="checkbox" id="v2-autocorr-check" checked> Vehicle 2</label>
                        <label><input type="checkbox" id="v3-autocorr-check" checked> Vehicle 3</label>
                    </div>
                    <div class="chart-container">
                        <canvas id="autocorrelationChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-panel-wrapper" id="psdPanel">
                <div class="chart-panel">
                    <h3>Power Spectral Density S(f)</h3>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="v1-psd-check" checked> Vehicle 1</label>
                        <label><input type="checkbox" id="v2-psd-check" checked> Vehicle 2</label>
                        <label><input type="checkbox" id="v3-psd-check" checked> Vehicle 3</label>
                    </div>
                    <div class="chart-container">
                        <canvas id="psdChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Physical constants
        const SPEED_OF_LIGHT = 3e8;

        // DOM elements
        const velocity1Input = document.getElementById('velocity1');
        const velocity2Input = document.getElementById('velocity2');
        const velocity3Input = document.getElementById('velocity3');
        const frequencyInput = document.getElementById('frequency');
        const scatterersInput = document.getElementById('scatterers');
        const simulateButton = document.getElementById('simulate-button');
        const envCanvas = document.getElementById('environmentCanvas');
        const envCtx = envCanvas.getContext('2d');
        const autocorrelationPanel = document.getElementById('autocorrelationPanel');
        const psdPanel = document.getElementById('psdPanel');
        
        // Checkboxes for plots
        const v1AutocorrCheck = document.getElementById('v1-autocorr-check');
        const v2AutocorrCheck = document.getElementById('v2-autocorr-check');
        const v3AutocorrCheck = document.getElementById('v3-autocorr-check');

        const v1PsdCheck = document.getElementById('v1-psd-check');
        const v2PsdCheck = document.getElementById('v2-psd-check');
        const v3PsdCheck = document.getElementById('v3-psd-check');

        // Chart canvases
        const autocorrCanvas = document.getElementById('autocorrelationChart');
        const psdCanvas = document.getElementById('psdChart');

        let autocorrelationChart = null;
        let psdChart = null;

        // Bessel function J0 approximation
        function besselJ0(x) {
            if (Math.abs(x) < 8.0) {
                const y = x * x;
                const ans1 = 57568490574.0 + y * (-13362590354.0 + y * (651619640.7 + 
                    y * (-11214424.18 + y * (77392.33017 + y * (-184.9052456)))));
                const ans2 = 57568490411.0 + y * (1029532985.0 + y * (9494680.718 + 
                    y * (59272.64853 + y * (267.8532712 + y * 1.0))));
                return ans1 / ans2;
            } else {
                const z = 8.0 / x;
                const y = z * z;
                const xx = x - 0.785398164;
                const ans1 = 1.0 + y * (-0.1098628627e-2 + y * (0.2734510407e-4 + 
                    y * (-0.2073370639e-5 + y * 0.2093887211e-6)));
                const ans2 = -0.1562499995e-1 + y * (0.1430488765e-3 + 
                    y * (-0.6911147651e-5 + y * (0.7621095161e-6 - y * 0.934935152e-7)));
                return Math.sqrt(0.636619772 / x) * (Math.cos(xx) * ans1 - z * Math.sin(xx) * ans2);
            }
        }

        // Draw scattering environment
        function drawEnvironment() {
            const width = envCanvas.width = envCanvas.offsetWidth;
            const height = envCanvas.height = envCanvas.offsetHeight;
            
            envCtx.clearRect(0, 0, width, height);
            
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.35;
            const numScatterers = parseInt(scatterersInput.value);

            // Draw circle
            envCtx.strokeStyle = '#667eea';
            envCtx.lineWidth = 3;
            envCtx.beginPath();
            envCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            envCtx.stroke();

            // Draw scatterers
            envCtx.fillStyle = '#48bb78';
            for (let i = 0; i < numScatterers; i++) {
                const angle = (2 * Math.PI * i) / numScatterers;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                
                envCtx.beginPath();
                envCtx.arc(x, y, 6, 0, 2 * Math.PI);
                envCtx.fill();
                
                // Draw path lines
                envCtx.strokeStyle = 'rgba(102, 126, 234, 0.3)';
                envCtx.lineWidth = 1;
                envCtx.beginPath();
                envCtx.moveTo(centerX, centerY);
                envCtx.lineTo(x, y);
                envCtx.stroke();
            }

            // Draw mobile receiver
            envCtx.fillStyle = '#e53e3e';
            envCtx.beginPath();
            envCtx.arc(centerX, centerY, 10, 0, 2 * Math.PI);
            envCtx.fill();
            
            // Add label
            envCtx.fillStyle = '#2d3748';
            envCtx.font = 'bold 14px Arial';
            envCtx.textAlign = 'center';
            envCtx.fillText('Rx', centerX, centerY + 5);

            // Add velocity arrow for the first vehicle
            const velocity = parseFloat(velocity1Input.value);
            if (velocity > 0) {
                envCtx.strokeStyle = '#e53e3e';
                envCtx.lineWidth = 3;
                envCtx.beginPath();
                envCtx.moveTo(centerX, centerY - 20);
                envCtx.lineTo(centerX + 30, centerY - 20);
                envCtx.stroke();
                
                // Arrow head
                envCtx.beginPath();
                envCtx.moveTo(centerX + 30, centerY - 20);
                envCtx.lineTo(centerX + 25, centerY - 25);
                envCtx.moveTo(centerX + 30, centerY - 20);
                envCtx.lineTo(centerX + 25, centerY - 15);
                envCtx.stroke();
                
                envCtx.fillStyle = '#2d3748';
                envCtx.font = '12px Arial';
                envCtx.fillText(`v = ${velocity} m/s`, centerX + 15, centerY - 30);
            }
        }

        // Calculate autocorrelation function
        function calculateAutocorrelation(velocity, frequency, maxTau) {
            const wavelength = SPEED_OF_LIGHT / frequency;
            const fD = velocity / wavelength;
            const numPoints = 100;
            const tauStep = maxTau / numPoints;
            
            const data = [];
            for (let i = 0; i <= numPoints; i++) {
                const tau = i * tauStep;
                const correlation = besselJ0(2 * Math.PI * fD * tau);
                data.push({ x: tau * 1000, y: correlation });
            }
            
            return data;
        }

        // Calculate power spectral density (Jakes spectrum)
        function calculatePSD(velocity, frequency) {
            const wavelength = SPEED_OF_LIGHT / frequency;
            const fD = velocity / wavelength;

            if (fD === 0) {
                return [{ x: 0, y: 1 }];
            }

            const numPoints = 200;
            const data = [];
            
            for (let i = 0; i <= numPoints; i++) {
                const f = (-fD * 1.5) + (i * 3 * fD) / numPoints;
                let psd = 0;
                
                if (Math.abs(f) < fD * 0.999) {
                    psd = 1 / (Math.PI * fD * Math.sqrt(1 - (f / fD) ** 2));
                }
                
                data.push({ x: f, y: psd });
            }
            
            return data;
        }

        // Updates all charts with current parameter values
        function updatePlots() {
            const velocities = [
                parseFloat(velocity1Input.value),
                parseFloat(velocity2Input.value),
                parseFloat(velocity3Input.value)
            ];
            const frequency = parseFloat(frequencyInput.value) * 1e6;
            const colors = ['#667eea', '#48bb78', '#fc8181'];
            
            // Determine a common maxTau for autocorrelation based on the slowest enabled vehicle
            const enabledVelocities = [];
            if (v1AutocorrCheck.checked) enabledVelocities.push(velocities[0]);
            if (v2AutocorrCheck.checked) enabledVelocities.push(velocities[1]);
            if (v3AutocorrCheck.checked) enabledVelocities.push(velocities[2]);
            
            let maxTau = 0;
            if (enabledVelocities.length > 0) {
                const minF_d = Math.min(...enabledVelocities.map(v => v / (SPEED_OF_LIGHT / frequency)));
                maxTau = 2 / Math.max(minF_d, 1);
            }
            
            // Autocorrelation chart
            if (autocorrelationChart) {
                autocorrelationChart.destroy();
            }
            
            const autocorrDatasets = [];
            if (v1AutocorrCheck.checked) {
                autocorrDatasets.push({
                    label: 'Vehicle 1',
                    data: calculateAutocorrelation(velocities[0], frequency, maxTau),
                    borderColor: colors[0],
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                });
            }
            if (v2AutocorrCheck.checked) {
                autocorrDatasets.push({
                    label: 'Vehicle 2',
                    data: calculateAutocorrelation(velocities[1], frequency, maxTau),
                    borderColor: colors[1],
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                });
            }
            if (v3AutocorrCheck.checked) {
                autocorrDatasets.push({
                    label: 'Vehicle 3',
                    data: calculateAutocorrelation(velocities[2], frequency, maxTau),
                    borderColor: colors[2],
                    backgroundColor: 'rgba(252, 129, 129, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                });
            }

            autocorrelationChart = new Chart(document.getElementById('autocorrelationChart'), {
                type: 'line',
                data: { datasets: autocorrDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Delay Ï„ (ms)'
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Correlation'
                            },
                            min: -1,
                            max: 1,
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        }
                    }
                }
            });

            // PSD chart
            if (psdChart) {
                psdChart.destroy();
            }
            
            const psdDatasets = [];
            if (v1PsdCheck.checked) {
                psdDatasets.push({
                    label: 'Vehicle 1',
                    data: calculatePSD(velocities[0], frequency),
                    borderColor: colors[0],
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0
                });
            }
            if (v2PsdCheck.checked) {
                psdDatasets.push({
                    label: 'Vehicle 2',
                    data: calculatePSD(velocities[1], frequency),
                    borderColor: colors[1],
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0
                });
            }
            if (v3PsdCheck.checked) {
                psdDatasets.push({
                    label: 'Vehicle 3',
                    data: calculatePSD(velocities[2], frequency),
                    borderColor: colors[2],
                    backgroundColor: 'rgba(252, 129, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0
                });
            }

            psdChart = new Chart(document.getElementById('psdChart'), {
                type: 'line',
                data: { datasets: psdDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Frequency (Hz)'
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Power Density'
                            },
                            min: 0,
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        }
                    }
                }
            });
            
            // Make plot sections visible
            autocorrelationPanel.style.display = 'block';
            psdPanel.style.display = 'block';
        }
        
        // Event listeners
        simulateButton.addEventListener('click', () => {
            updatePlots();
            drawEnvironment();
        });

        // Listeners for all velocity and frequency inputs to redraw the environment
        velocity1Input.addEventListener('input', drawEnvironment);
        velocity2Input.addEventListener('input', drawEnvironment);
        velocity3Input.addEventListener('input', drawEnvironment);
        frequencyInput.addEventListener('input', drawEnvironment);
        scatterersInput.addEventListener('input', drawEnvironment);

        // Listeners for the checkboxes to update the plots
        v1AutocorrCheck.addEventListener('change', updatePlots);
        v2AutocorrCheck.addEventListener('change', updatePlots);
        v3AutocorrCheck.addEventListener('change', updatePlots);

        v1PsdCheck.addEventListener('change', updatePlots);
        v2PsdCheck.addEventListener('change', updatePlots);
        v3PsdCheck.addEventListener('change', updatePlots);
        
        window.addEventListener('resize', () => {
            setTimeout(() => {
                if (autocorrelationChart) {
                    updatePlots();
                }
                drawEnvironment();
            }, 100);
        });

        // Initial state: hide chart panels and draw environment
        autocorrelationPanel.style.display = 'none';
        psdPanel.style.display = 'none';
        drawEnvironment();
    </script>
</body>
</html>